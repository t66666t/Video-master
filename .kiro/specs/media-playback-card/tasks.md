# 实现计划：媒体播放列表与底部快捷播放卡片

## 概述

本实现计划将媒体播放列表和底部快捷播放卡片功能分解为可执行的编码任务。实现采用增量方式，每个任务都建立在前一个任务的基础上。

## 任务列表

- [x] 1. 添加依赖并创建核心服务基础结构
  - 在 pubspec.yaml 中添加 audio_service 和 audio_session 依赖
  - 创建 lib/services/media_playback_service.dart 基础结构
  - 创建 lib/services/playlist_manager.dart 基础结构
  - 创建 lib/services/progress_tracker.dart 基础结构
  - 在 main.dart 中注册新服务到 Provider
  - _需求: 5.1, 5.2, 7.1_

- [-] 2. 实现 PlaylistManager 播放列表管理器
  - [x] 2.1 实现播放列表核心逻辑
    - 实现 setPlaylist 方法设置播放列表
    - 实现 loadFolderPlaylist 方法从 LibraryService 加载同文件夹媒体
    - 实现 getNext/getPrevious 导航方法
    - 实现 hasNext/hasPrevious 边界检查
    - _需求: 3.1, 4.2, 4.3_
  - [ ]* 2.2 编写 PlaylistManager 属性测试
    - **属性 3: 播放列表文件夹过滤**
    - **属性 6: 播放列表导航边界**
    - **验证: 需求 3.1, 4.2, 4.3**

- [x] 3. 实现 ProgressTracker 进度追踪器
  - [x] 3.1 实现进度保存核心逻辑
    - 实现 saveProgress 方法（带5秒防抖）
    - 实现 saveProgressImmediately 方法（立即保存）
    - 实现 getProgress 方法读取保存的进度
    - 集成 LibraryService 更新 VideoItem.lastPositionMs
    - _需求: 7.1, 7.2, 7.3, 7.5_
  - [x] 3.2 实现播放状态快照
    - 创建 PlaybackStateSnapshot 数据模型
    - 实现 savePlaybackState 方法保存当前播放状态
    - 实现 restorePlaybackState 方法恢复播放状态
    - 使用 SharedPreferences 存储状态快照
    - _需求: 7.4_
  - [ ]* 3.3 编写 ProgressTracker 属性测试
    - **属性 10: 进度保存往返一致性**
    - **属性 11: 进度定期保存**
    - **属性 12: 暂停时立即保存**
    - **验证: 需求 7.1, 7.2, 7.4**

- [-] 4. 实现 MediaPlaybackService 媒体播放服务
  - [x] 4.1 实现播放控制核心逻辑
    - 实现单例模式和状态管理
    - 实现 play 方法（支持从指定位置开始播放）
    - 实现 pause/resume/stop 方法
    - 实现 seekTo 方法精确跳转
    - 集成 ProgressTracker 自动保存进度
    - _需求: 4.1, 4.4, 7.1, 7.2, 7.3_
  - [x] 4.2 实现播放列表导航
    - 集成 PlaylistManager
    - 实现 playNext/playPrevious 方法
    - 实现媒体切换时的位置恢复逻辑
    - _需求: 3.3, 4.2, 4.3, 7.6_
  - [x] 4.3 实现音量和静音控制
    - 实现 setVolume 方法
    - 实现 toggleMute 方法
    - 保持与现有播放页面静音逻辑一致
    - _需求: 4.5_
  - [ ]* 4.4 编写 MediaPlaybackService 属性测试
    - **属性 4: 媒体切换位置恢复**
    - **属性 5: 播放状态切换**
    - **属性 8: 静音状态切换**
    - **验证: 需求 3.3, 4.1, 4.5, 7.6**

- [ ] 5. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 6. 实现响应式布局计算器
  - [x] 6.1 创建 PlaybackCardLayout 布局计算器
    - 创建 lib/widgets/playback_card_layout.dart
    - 实现 calculate 方法根据屏幕宽度计算尺寸
    - 定义 PlaybackCardDimensions 数据类
    - 手机(<600dp): 高度85dp, 缩略图50dp, 字体14sp
    - 平板(600-1200dp): 高度95dp, 缩略图60dp, 字体15sp
    - 桌面(>=1200dp): 高度75dp, 缩略图50dp, 字体14sp
    - _需求: 2.1, 2.2, 2.3_
  - [ ]* 6.2 编写响应式布局属性测试
    - **属性 2: 响应式布局尺寸计算**
    - **验证: 需求 2.1, 2.2, 2.3**

- [x] 7. 实现 MiniPlaybackCard 底部播放卡片UI
  - [x] 7.1 创建播放卡片基础结构
    - 创建 lib/widgets/mini_playback_card.dart
    - 实现第一行布局：缩略图、标题、列表展开按钮
    - 实现第二行布局：进度条、控制按钮
    - 使用 PlaybackCardLayout 进行响应式布局
    - _需求: 1.5, 2.4, 2.5_
  - [x] 7.2 实现标题滚动动画
    - 当标题宽度超过可用空间时启用滚动
    - 实现缓慢循环滚动效果
    - 使用 AnimationController 控制滚动
    - _需求: 2.6_
  - [x] 7.3 实现进度条和播放控制
    - 实现可拖动进度条
    - 实现播放/暂停按钮
    - 实现上一集/下一集按钮
    - 实现静音按钮
    - 连接 MediaPlaybackService
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
  - [x] 7.4 实现卡片显示/隐藏动画
    - 实现滑入/滑出动画（300ms）
    - 使用 AnimatedSlide 或 SlideTransition
    - 确保动画流畅且性能高效
    - _需求: 1.1, 1.2, 8.1_
  - [ ]* 7.5 编写播放卡片显示条件属性测试
    - **属性 1: 播放卡片显示条件一致性**
    - **验证: 需求 1.3**

- [ ] 8. 实现 PlaylistBottomSheet 播放列表弹窗
  - [x] 8.1 创建播放列表弹窗组件
    - 创建 lib/widgets/playlist_bottom_sheet.dart
    - 实现媒体列表显示（从上到下排列）
    - 实现当前播放项高亮
    - 实现点击切换媒体功能
    - _需求: 3.1, 3.2, 3.3, 3.5_
  - [x] 8.2 实现弹窗展开/收起逻辑
    - 点击列表展开按钮显示弹窗
    - 点击列表外区域或再次点击按钮收起
    - 实现平滑的展开/收起动画
    - _需求: 3.4_

- [x] 9. 集成播放卡片到主页面
  - [x] 9.1 修改 HomeScreen 集成播放卡片
    - 在 Scaffold 底部添加 MiniPlaybackCard
    - 确保卡片不遮挡媒体卡片内容
    - 根据播放状态控制卡片显示/隐藏
    - _需求: 1.1, 1.2, 1.3, 1.4_
  - [x] 9.2 修改 CollectionScreen 集成播放卡片
    - 在 Scaffold 底部添加 MiniPlaybackCard
    - 保持与 HomeScreen 一致的行为
    - _需求: 1.1, 1.2, 1.3, 1.4_
  - [x] 9.3 修改视频播放页面集成
    - 修改 VideoPlayerScreen 使用 MediaPlaybackService
    - 修改 PortraitVideoScreen 使用 MediaPlaybackService
    - 确保播放状态在页面间同步
    - _需求: 1.2_

- [ ] 10. 检查点 - 确保UI集成正常
  - 确保所有测试通过，如有问题请询问用户

- [x] 11. 实现后台播放和系统控制
  - [x] 11.1 创建 AudioSessionService
    - 创建 lib/services/audio_session_service.dart
    - 配置 audio_service 后台播放
    - 实现 AudioHandler 处理媒体控制
    - _需求: 5.1, 5.2_
  - [x] 11.2 实现通知栏媒体控制
    - 配置通知栏显示媒体信息
    - 实现播放/暂停/上一曲/下一曲按钮
    - 显示媒体标题和封面
    - _需求: 5.3, 5.4_
  - [x] 11.3 实现耳机控制支持
    - 处理媒体按键事件
    - 实现播放/暂停键响应
    - 实现上一曲/下一曲键响应
    - _需求: 6.1, 6.2, 6.3_
  - [x] 11.4 平台特定配置
    - Android: 配置 AndroidManifest.xml 前台服务权限
    - iOS: 配置 Info.plist 后台音频权限
    - Windows: 配置系统媒体传输控制
    - _需求: 6.4_
  - [ ]* 11.5 编写系统控制响应属性测试
    - **属性 9: 媒体控制命令响应**
    - **验证: 需求 5.4, 6.1, 6.2, 6.3**

- [x] 12. 实现应用恢复播放状态
  - [x] 12.1 实现应用启动时恢复播放状态
    - 在 main.dart 中恢复上次播放状态
    - 如果上次是播放状态，显示播放卡片但不自动播放
    - 恢复播放位置和播放列表
    - _需求: 7.4_
  - [ ]* 12.2 编写进度切换保存属性测试
    - **属性 13: 切换时保存进度**
    - **验证: 需求 7.3**

- [x] 13. 视觉优化和样式调整
  - [x] 13.1 应用深色主题样式
    - 使用应用一致的配色（#1E1E1E, #2C2C2C）
    - 应用圆角设计（12-16dp）
    - 添加适当的阴影效果
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_
  - [x] 13.2 优化动画性能
    - 确保动画使用硬件加速
    - 优化标题滚动动画性能
    - 验证60fps帧率
    - _需求: 8.2, 8.3, 8.4_

- [x] 14.目前需要增加：1:快捷播放卡片的进度条下面可以加一行小字说明当前播放的进度（不能增加卡片高度）；2：播放列表的缩略图并没有正确展示视频的缩略图，而且如果是音频我希望那个缩略图能是音频的图标而非视频的图标

- [x] 15.请在快捷播放卡片的视频标题那一行和播放进度条那一行中间在加入一小行，用于显示当前正在播放音视频的主字幕内容。（这个展示界面会展示音视频卡片正在播放的主字幕的内容，并且此处展示的字幕是连续的，也就是说前一个字幕的结束时间延后到后一个字幕开始的时间）。此外，这一行最右侧加入两个间隔略紧凑的小按钮，前一个点击后跳转到前一句字幕的开始时间，后一个则跳转到后一句字幕的开始时间（多次点击可累计）。由于这个增加的一行，你可以略微增加快捷播放卡片的高度用于容纳这新的一行。

- [x] 16.快捷播放卡片的播放进度无法实时同步（点击进度条跳转时确实能同步，但是我正常播放时进度不会同步）。请修复，并且确保同步是实时的且不会耗费过多性能


- [x] 17.修复快捷播放卡片的播放/暂停与播放页不同步的问题。（具体现象是：我在快捷播放页暂停了视频，点击视频播放页却直接开始播放了）
- [x] 18.请完善：在手机端的通知栏无法控制某一音视频的进度且不能切换上一个或下一个视频（显示不出视频标题缩略图，控制不了播放暂停）。我希望能模仿音乐软件。

- [x] 19.快捷播放卡片的字幕显示区并没有正确识别到视频正在播放的字幕。请修复。并且我希望如果字幕长度超出范围可以用手左右滑动来看到更长的信息。此外，快捷播放卡片的字幕显示区的高度，按钮和字体可以再大一点点，不要斜体

- [ ] 20.

- [ ] 21.

- [ ] 22.


## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点任务用于验证增量进度
- 属性测试使用 `glados` 库实现

